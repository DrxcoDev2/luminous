
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // --- User Settings ---
    // Manages user-specific information like company name, timezone, and teamId.
    match /userSettings/{userId} {
      // Allow any signed-in user to read settings (needed for searching users by email).
      allow read: if isSignedIn();
      
      // Allow a user to write to their own settings.
      // Also allow a team owner to update the teamId of another user.
      allow write: if isSignedIn() && (
        // Case 1: User is updating their own document
        request.auth.uid == userId ||
        // Case 2: A team owner is updating another user's teamId
        get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.ownerId == request.auth.uid
      );
    }

    // --- Teams ---
    // Manages team members and ownership.
    match /teams/{teamId} {
      // Allow read if the user is a member of the team.
      allow read: if isSignedIn() && request.auth.uid in resource.data.members.map(member => member.uid);
      
      // Allow write (adding/removing members) only if the user is the owner.
      allow write: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // --- Clients ---
    // Manages client data.
    match /clients/{clientId} {
      // Allow read/write if the user created the client OR if the user is part of the client's team.
      allow read, write: if isSignedIn() && 
        (request.auth.uid == resource.data.userId || 
         get(/databases/$(database)/documents/userSettings/$(request.auth.uid)).data.teamId == resource.data.teamId);
    }

    // --- Mail ---
    // Used for triggering emails.
    match /mail/{docId} {
      allow create: if isSignedIn();
    }

    // --- Feedback ---
    // Used for collecting user feedback.
    match /feedback/{docId} {
      allow create: if isSignedIn();
    }
  }
}
